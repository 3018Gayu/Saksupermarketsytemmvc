@model Saksupermarketsytemmvc.web.Models.Dashboard
@{
    ViewData["Title"] = "Dashboard";
    var userRole = User.IsInRole("Admin") ? "Admin" :
                   User.IsInRole("Cashier") ? "Cashier" :
                   User.IsInRole("Inventory Manager") ? "Inventory Manager" : "";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

<style>
    .clickable-card {
        cursor: pointer;
        transition: 0.25s ease;
    }

        .clickable-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 18px rgba(0,0,0,0.25);
        }

    .equal-height {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .decorative-card {
        position: relative;
        overflow: hidden;
    }

        .decorative-card .bg-circle {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            top: -20px;
            right: -20px;
            z-index: 0;
        }

        .decorative-card i {
            position: relative;
            z-index: 1;
        }
</style>

<div class="container mt-4">
    <h2 class="mb-4">@userRole DASHBOARD</h2>

    @* ------------------------------ ADMIN SECTION ------------------------------ *@
    @if (userRole == "Admin")
    {
        <div class="row mb-4 g-3">
            <div class="col-md-3 d-flex">
                <div class="card text-center bg-primary text-white p-3 shadow-sm equal-height w-100 decorative-card">
                    <div class="bg-circle"></div>
                    <i class="bi bi-cash-stack fs-2 mb-2"></i>
                    <div>Total Sales</div>
                    <h4>₹@Model.TotalSales</h4>
                </div>
            </div>

            <div class="col-md-3 d-flex">
                <a asp-controller="Customer" asp-action="Index" class="text-decoration-none h-100 w-100">
                    <div class="card text-center bg-success text-white p-3 shadow-sm clickable-card equal-height decorative-card">
                        <div class="bg-circle"></div>
                        <i class="bi bi-people fs-2 mb-2"></i>
                        <div>Customers</div>
                        <h4>@Model.CustomerCount</h4>
                    </div>
                </a>
            </div>

            <div class="col-md-3 d-flex">
                <a asp-controller="Products" asp-action="StockStatus" class="text-decoration-none h-100 w-100">
                    <div class="card text-center bg-danger text-white p-3 shadow-sm clickable-card equal-height decorative-card">
                        <div class="bg-circle"></div>
                        <i class="bi bi-exclamation-triangle fs-2 mb-2"></i>
                        <div>Low Stock</div>
                        <h4>@Model.LowStockCount</h4>
                    </div>
                </a>
            </div>

            <div class="col-md-3 d-flex">
                <a asp-controller="User" asp-action="Index" class="text-decoration-none h-100 w-100">
                    <div class="card text-center bg-secondary text-white p-3 shadow-sm clickable-card equal-height decorative-card">
                        <div class="bg-circle"></div>
                        <i class="bi bi-person-badge fs-2 mb-2"></i>
                        <div>Users</div>
                        <h4>@Model.UserCount</h4>
                    </div>
                </a>
            </div>
        </div>

        <h5 class="mt-4 mb-3">Sales Last 7 Days</h5>
        <canvas id="salesChart" height="120"></canvas>

        <h5 class="mt-5 mb-3">Recent Transactions</h5>
        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Invoice</th>
                        <th>Customer</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var t in Model.RecentTransactions)
                    {
                        <tr>
                            <td>@(DateTime.TryParse(t.Date, out var dtT) ? dtT.ToString("dd/MM/yyyy") : t.Date)</td>
                            <td>INV@(t.InvoiceNo)</td>
                            <td>@t.Customer</td>
                            <td>₹@t.Amount</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @* ------------------------------ CASHIER SECTION ------------------------------ *@
    @if (userRole == "Cashier")
    {
        <div class="row mb-4 g-3">
            <div class="col-md-6 d-flex">
                <div class="card text-center bg-primary text-white p-3 shadow-sm equal-height w-100 decorative-card">
                    <div class="bg-circle"></div>
                    <i class="bi bi-cash-stack fs-2 mb-2"></i>
                    <div>Today's Sales</div>
                    <h4>₹@Model.TodaysSales</h4>
                </div>
            </div>

            <div class="col-md-6 d-flex">
                <div class="card text-center bg-success text-white p-3 shadow-sm equal-height w-100 decorative-card">
                    <div class="bg-circle"></div>
                    <i class="bi bi-receipt fs-2 mb-2"></i>
                    <div>Invoices Today</div>
                    <h4>@Model.TodaysInvoices</h4>
                </div>
            </div>
        </div>

        <h5>Quick Billing Panel</h5>
        <div class="list-group mb-4">
            <a href="@Url.Action("Create", "Billing")" class="list-group-item list-group-item-action">
                1) Create New Invoice
            </a>
            <a href="@Url.Action("Index", "Customer")" class="list-group-item list-group-item-action">
                2) Search Customer
            </a>
        </div>

        <h5>Recent Bills</h5>
        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Time</th>
                        <th>Invoice</th>
                        <th>Customer</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var b in Model.RecentBills)
                    {
                        <tr>
                            <td>@(DateTime.TryParse(b.Date, out var dtB) ? dtB.ToString("dd/MM/yyyy HH:mm") : b.Date)</td>
                            <td>INV@(b.InvoiceNo)</td>
                            <td>@b.Customer</td>
                            <td>₹@b.Amount</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @* ------------------------------ INVENTORY MANAGER SECTION ------------------------------ *@
    @if (userRole == "Inventory Manager")
    {
        <h5>Low Stock Alerts</h5>
        @foreach (var p in Model.LowStockProducts)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-circle-fill"></i> @p.Name - @p.StockQty left
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <h5>Expired Products</h5>
        @foreach (var p in Model.ExpiredProducts)
        {
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="bi bi-calendar-x-fill"></i> @p.Name - Expired on @p.ExpiryDate?.ToString("dd/MM/yyyy")
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <div class="row mb-4 g-3">

            @* PRODUCTS *@
            <div class="col-md-3 d-flex">
                <a asp-controller="Products" asp-action="Index" class="text-decoration-none h-100 w-100">
                    <div class="card text-center bg-primary text-white p-3 shadow-sm clickable-card equal-height decorative-card">
                        <div class="bg-circle"></div>
                        <i class="bi bi-box-seam fs-2 mb-2"></i>
                        <div>Products</div>
                        <h4>@Model.ProductsCount</h4>
                    </div>
                </a>
            </div>

            @* SUPPLIERS *@
            <div class="col-md-3 d-flex">
                <a asp-controller="Supplier" asp-action="Index" class="text-decoration-none h-100 w-100">
                    <div class="card text-center bg-success text-white p-3 shadow-sm clickable-card equal-height decorative-card">
                        <div class="bg-circle"></div>
                        <i class="bi bi-truck fs-2 mb-2"></i>
                        <div>Suppliers</div>
                        <h4>@Model.SupplierCount</h4>
                    </div>
                </a>
            </div>

            @* ORDERS *@
            <div class="col-md-3 d-flex">
                <a asp-controller="Orders" asp-action="Index" class="text-decoration-none h-100 w-100">
                    <div class="card text-center bg-warning text-white p-3 shadow-sm clickable-card equal-height decorative-card">
                        <div class="bg-circle"></div>
                        <i class="bi bi-receipt fs-2 mb-2"></i>
                        <div>Orders</div>
                        <h4>@Model.OrdersCount</h4>
                    </div>
                </a>
            </div>

            @* ORDER DETAILS *@
            <div class="col-md-3 d-flex">
                <a asp-controller="OrderDetails" asp-action="Index" class="text-decoration-none h-100 w-100">
                    <div class="card text-center bg-info text-white p-3 shadow-sm clickable-card equal-height decorative-card">
                        <div class="bg-circle"></div>
                        <i class="bi bi-list-check fs-2 mb-2"></i>
                        <div>Order Details</div>
                        <h4>@Model.OrderDetailsCount</h4>
                    </div>
                </a>
            </div>

        </div>

        <h5>Recently Added Products</h5>
        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Product Name</th>
                        <th>Stock Quantity</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in Model.RecentProducts)
                    {
                        <tr>
                            <td>@p.Name</td>
                            <td>@p.StockQty</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const ctx = document.getElementById('salesChart')?.getContext('2d');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Last7DaysLabels)),
                datasets: [{
                    label: 'Sales Amount (₹)',
                    data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Last7DaysSales)),
                    backgroundColor: 'rgba(0, 123, 255, 0.2)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 5,
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 100
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
    }
</script>
