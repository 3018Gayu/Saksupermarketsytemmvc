@model Saksupermarketsytemmvc.web.Models.Dashboard
@{
    ViewData["Title"] = "Dashboard";
    var userRole = User.IsInRole("Admin") ? "Admin" :
                   User.IsInRole("Cashier") ? "Cashier" :
                   User.IsInRole("Inventory Manager") ? "Inventory Manager" : "";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<div class="container mt-4">
    <h2>@userRole DASHBOARD</h2>

    @* ---------------- ADMIN ---------------- *@
    @if (userRole == "Admin")
    {
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card p-3 text-center bg-primary text-white">
                    Total Sales<br>₹@Model.TotalSales
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 text-center bg-success text-white">
                    Customers<br>@Model.CustomerCount
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 text-center bg-danger text-white">
                    Low Stock<br>@Model.LowStockCount
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 text-center bg-secondary text-white">
                    Users<br>@Model.UserCount
                </div>
            </div>
        </div>

        <h5>Sales Last 7 Days</h5>
        <canvas id="salesChart" height="100"></canvas>

        <h5 class="mt-4">Recent Transactions</h5>
        <table class="table table-bordered">
            <thead>
                <tr><th>Date</th><th>Invoice</th><th>Customer</th><th>Amount</th><th>Cashier</th></tr>
            </thead>
            <tbody>
                @foreach (var t in Model.RecentTransactions)
                {
                    <tr>
                        <td>@t.Date</td>
                        <td>@("INV" + t.InvoiceNo)</td>
                        <td>@t.Customer</td>
                        <td>₹@t.Amount</td>
                        <td>@t.Cashier</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    @* ---------------- CASHIER ---------------- *@
    @if (userRole == "Cashier")
    {
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card p-3 text-center bg-primary text-white">
                    Today's Sales<br>₹@Model.TodaysSales
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3 text-center bg-success text-white">
                    Invoices Today<br>@Model.TodaysInvoices
                </div>
            </div>
        </div>

        <h5>Quick Billing Panel</h5>
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="list-group">
                    <a href="@Url.Action("Create", "Billing")" class="list-group-item list-group-item-action">
                        1) Create New Invoice
                    </a>

                    <a href="@Url.Action("Index", "Customer")" class="list-group-item list-group-item-action">
                        2) Search Customer
                    </a>
                </div>
            </div>
        </div>

        <h5>Recent Bills</h5>
        <table class="table table-bordered">
            <thead>
                <tr><th>Time</th><th>Invoice</th><th>Customer</th><th>Amount</th></tr>
            </thead>
            <tbody>
                @foreach (var b in Model.RecentBills)
                {
                    <tr>
                        <td>@b.Date</td>
                        <td>@("INV" + b.InvoiceNo)</td>
                        <td>@b.Customer</td>
                        <td>₹@b.Amount</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    @* ---------------- INVENTORY MANAGER ---------------- *@
    @if (userRole == "Inventory Manager")
    {
        <h5>Low Stock Alerts</h5>
        @foreach (var p in Model.LowStockProducts)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @p.Name - @p.StockQty left
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <h5>Expired Products</h5>
        @foreach (var p in Model.ExpiredProducts)
        {
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                @p.Name - Expired on @p.ExpiryDate?.ToString("dd/MM/yyyy")
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card p-3 text-center bg-primary text-white">
                    Products<br>@Model.ProductsCount
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 text-center bg-success text-white">
                    Suppliers<br>@Model.SupplierCount
                </div>
            </div>
        </div>

        <h5>Recently Added Products</h5>
        <table class="table table-bordered">
            <thead>
                <tr><th>Product ID</th><th>Product Name</th></tr>
            </thead>
            <tbody>
                @foreach (var p in Model.RecentProducts)
                {
                    <tr>
                        <td>@p.ProductId</td>
                        <td>@p.Name</td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    var ctx = document.getElementById('salesChart')?.getContext('2d');
    if(ctx){
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Last7DaysLabels)),
                datasets: [{
                    label: 'Sales Amount (₹)',
                    data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Last7DaysSales)),
                    backgroundColor: 'rgba(0, 123, 255, 0.2)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { responsive: true }
        });
    }
</script>
